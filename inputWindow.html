<!DOCTYPE <!DOCTYPE html>
<html>
<head>
    <title>Adauga date</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
</head>
<body>
    <form class="display:table">
        <div >
            <a>Încărcare date: </a>
            <div class="display:table-cell" id="table">
                <input type="text" disabled placeholder=".csv" id="pathInput">
                <input type="file" id="dataset" style="display: none;" />
                <input type="button" class="btn btn-warning" value="Caută" onclick="document.getElementById('dataset').click();" />
            </div>
        </div>
        <br/>
        <div style="visibility: hidden;" id="listbox">
            <label>Alege un an:</label>
            <div id="populateMe"></div>
        </div>
        <br/>
        <button type="submit" class="btn btn-outline-success btn-lg">OK</button>
    </form>

    <script>
        "use strict";
        const electron = require('electron');
        const { ipcRenderer } = electron;
        const readSingleFile = require('./libs/fileReader');
        const csvToArray = require('./libs/csvToArray');
        const parser = require('./libs/dataConverter.js');

        const path = document.querySelector('#pathInput');
        const dataSet = document.querySelector('#dataset');
        const form = document.querySelector('form');

        const csvData = [];

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const selected = document.querySelector("#selectList");
            if (selected === null || selected === undefined || selected === ""){
                alert("Ups!\nAlegeti un fisier .csv!");
            }
            if (selected.selectedIndex < 0){
                alert("Alegeti un alt set de date");
            }
            const value = selected.options[selected.selectedIndex].value;
            var userPick = parseInt(value);
            var index = csvData[0].years.indexOf(parseInt(userPick));
            var total = [];
            if (csvData[0].total !== null){
                    csvData[0].total.forEach(e => { 
                    if (e.year === userPick) { 
                        total.push( {gender: e.gender, value: e.total });
                    }
                });
            }
            const resObj = { pyramidData: csvData[0].data[index], year: userPick, total: total }
            ipcRenderer.send('data', resObj);
        });
        
        // Callback function for 
        // ToDo: handle error
        const loadedCallbackA = function(data){
            const csvResult = csvToArray.toCsv(data, ',');
            const result = parser.parseData(csvResult);
            if (result.errors.length === 0)
            {
                const selectBox = document.querySelector("#listbox");
                const yearField = document.querySelector("#populateMe");
                yearField.innerHTML = "";

                selectBox.style.visibility = 'visible';

                const selectList = document.createElement("select");
                selectList.id = "selectList";
                yearField.appendChild(selectList);

                result.value.years.forEach(element => {
                    var option = document.createElement("option");
                    option.value = element;
                    option.text = element;
                    selectList.appendChild(option);
                });
                csvData.push(result.value);
            } else {
                alert("A aparut o eroare: " + result.errors);
            }
        }    

        dataSet.addEventListener('change', function(){
            if (dataSet.files.length > 0){
                const dataset = document.querySelector('#dataset');
                // Update display path
                path.value = dataset.files[0].path;
                // Read into memory
                readSingleFile.getAsText(dataset.files[0], loadedCallbackA);
            }
        });
    </script>
</body>
</html>